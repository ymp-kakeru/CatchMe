<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Catch me if you can</title>
    </head>
    <body>
        <h1>Catch me if you can</h1>
        <p id="status">OpenCV.js is loading...</p>
        <div>
            <button id="start" type="button">Start</button>
            <button id="stop" type="button">Stop</button>
            <button id="capture" type="button">Capture</button>
        </div>
        <div>
            <h2>Raw Video (Colour)</h2>
            <div><video id="video" width="640" height="480" playsinline="" muted="" autoplay=""></video></div>
        </div>

        <div>
            <h2>OpenCv Canvas (Gray)</h2>
            <div>
                <canvas id="canvas" width="640" height="480"></canvas>
            </div>
        </div>
    </body>
    <script>

        // https://docs.opencv.org/3.4.0/dd/d00/tutorial_js_video_display.html
        
        // Video Settings
        const width  = 640;
        const height = 480;
        const fps = 30;
        
        // Globals
        let videoCapture = null;
        let stream = null;
        let isStreaming = false;
        let matSrc = null;
        let matDst = null;
        
        // Elements
        const videoElem  = document.getElementById('video');
        const canvasElem = document.getElementById('canvas');
        const startButtonElem = document.getElementById('start');
        const stopButtonElem  = document.getElementById('stop');
        const captureButtonelem = document.getElementById('capture');
        const statusElem = document.getElementById('status');
        
        // ================================================================================
        
        /** On OpenCV.js Loaded */
        function onCvLoaded() {
          console.log('on OpenCV.js Loaded', cv);
          
          cv.onRuntimeInitialized = onReady;  // Not Working...
          statusElem.innerText = 'On OpenCV.js Loaded';
        }
        
        /** On Ready */
        function onReady() {
          console.log('On Ready');
          
          // Set Element Size
          videoElem.width  = canvasElem.width  = width;
          videoElem.height = canvasElem.height = height;
          // Start Video Capture
          videoCapture = new cv.VideoCapture(videoElem);
          // Set Button Events
          startButtonElem.addEventListener('click', onStart);
          startButtonElem.disabled = false;
          stopButtonElem.addEventListener('click', onStop);
          stopButtonElem.disabled  = true;
          captureButtonelem.addEventListener('click',capture);
          
          statusElem.innerText = 'Ready';
        };
        
        /** On Window Loaded */
        window.addEventListener('load', () => {
          console.log('Window Loaded');
          
          onReady();  // cv.onRuntimeInitialized Is Not Working, So This Is Fallback
        });
        
        /** On Start */
        function onStart() {
          navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false
          })
            .then((_stream) => {
              console.log('On Start : Success');
              
              stream = videoElem.srcObject = _stream;
              videoElem.play();
              
              matSrc = new cv.Mat(height, width, cv.CV_8UC4);  // For Video Capture
              matDst = new cv.Mat(height, width, cv.CV_8UC1);  // For Canvas Preview
              
              // Start Process Video
              setTimeout(processVideo, 0);
              
              isStreaming = true;
              startButtonElem.disabled = true;
              stopButtonElem.disabled  = false;
            })
            .catch((error) => {
              console.error('On Start : Error', error);
            });
        }
        
        /** On Stop */
        function onStop() {
          console.log('On Stop');
          
          videoElem.pause();
          videoElem.srcObject = null;
          stream.getVideoTracks()[0].stop();
          
          isStreaming = false;
          startButtonElem.disabled = false;
          stopButtonElem.disabled  = true;
        }
        
        /** Process Video */
        function processVideo() {
          if(!isStreaming) {
            console.log('Process Video : Streaming Stopped');
            
            matSrc.delete();
            matDst.delete();
            return;
          }
          
          const begin = Date.now();
          videoCapture.read(matSrc);  // Capture Video Image To Mat Src
          cv.cvtColor(matSrc, matDst, cv.COLOR_RGBA2GRAY);  // Convert Colour To Grey
          cv.imshow('canvas', matDst);  // Set Element ID
          
          // Loop
          const delay = 1000 / fps - (Date.now() - begin);
          setTimeout(processVideo, delay);
        }

        function capture() {
            img = new cv.Mat(height, width, cv.CV_8UC4)
            videoCapture.read(img)
            
            img_name = "captured.jpeg".format;
            cv.imwrite(img_name,img);            
        }
        
        </script>
        <script src="./opencv.js" onload="onCvLoaded()"></script>
</html>